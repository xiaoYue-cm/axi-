{% extends "layout.html" %}

{% block content %}
<div class="upload-form">
    <h1>æ–‡ä»¶è§£ç </h1>
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        <div class="form-group">
            <label>
                <span class="label-text">é€‰æ‹©Luaæ–‡ä»¶</span>
                <span class="required">*</span>
            </label>
            <div class="file-drop-area" id="dropArea">
                <input type="file" name="file" accept=".lua,.alp" required id="fileInput">
                <div class="drop-message">
                    <span class="icon">ğŸ“</span>
                    <p>æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <p class="sub-text">æ”¯æŒ .lua å’Œ .alp æ–‡ä»¶</p>
                </div>
            </div>
            <div class="field-hint">è¯·é€‰æ‹©éœ€è¦è§£ç çš„Luaæ–‡ä»¶</div>
        </div>
        
        <div class="form-group">
            <label>
                <span class="label-text">è§£å¯†æ–¹å¼</span>
                <span class="required">*</span>
            </label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="decode_method" value="vm_decrypt" checked>
                    VMè§£å¯† (Vm_RENåŠ å›º .alpæ–‡ä»¶)
                </label>
                <label class="radio-label">
                    <input type="radio" name="decode_method" value="all">
                    å°è¯•æ‰€æœ‰è§£å¯†æ–¹å¼ (.luaæ–‡ä»¶)
                </label>
            </div>
        </div>
        
        <div class="form-group decode-order" style="display: none;">
            <label>
                <span class="label-text">è§£å¯†é¡ºåº</span>
                <span class="required">*</span>
            </label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="decode_order" value="binary_first" checked>
                    å…ˆäºŒè¿›åˆ¶è§£å¯†ï¼Œå†è¿›è¡Œå…¶ä»–è§£å¯†
                </label>
                <label class="radio-label">
                    <input type="radio" name="decode_order" value="binary_last">
                    å…ˆè¿›è¡Œå…¶ä»–è§£å¯†ï¼Œå†è¿›è¡ŒäºŒè¿›åˆ¶è§£å¯†
                </label>
            </div>
        </div>
        
        <div class="button-group">
            <button type="submit">å¼€å§‹è§£ç </button>
            <button type="button" class="clear-btn" id="clearBtn">æ¸…é™¤æ‰€æœ‰æ–‡ä»¶</button>
        </div>
    </form>
    
    <div class="decoded-files">
        <h2>å·²è§£ç æ–‡ä»¶</h2>
        <div class="file-list">
            {% if decoded_files %}
                {% for file in decoded_files %}
                <div class="file-item">
                    <span class="file-name">{{ file }}</span>
                    <div class="file-actions">
                        <span class="decode-method">
                            {% if 'vm_decrypt' in file %}VMè§£å¯†
                            {% elif 'binary_first' in file %}å…ˆäºŒè¿›åˆ¶åè§£å¯†
                            {% elif 'binary_last' in file %}å…ˆè§£å¯†åäºŒè¿›åˆ¶
                            {% elif 'binary' in file %}ä»…äºŒè¿›åˆ¶è§£å¯†
                            {% elif 'bacon' in file %}åŸ¹æ ¹å¯†ç 
                            {% elif 'rail_fence' in file %}æ …æ å¯†ç 
                            {% elif 'route' in file %}æ›²è·¯å¯†ç 
                            {% elif 'columnar' in file %}åˆ—ç§»ä½å¯†ç 
                            {% elif '01248' in file %}01248å¯†ç 
                            {% endif %}
                        </span>
                        <a href="{{ url_for('download_file', filename=file) }}" class="download-btn">ä¸‹è½½</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-files">æš‚æ— å·²è§£ç æ–‡ä»¶</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è§£å¯†æ–¹å¼åˆ‡æ¢é€»è¾‘
    const decodeMethodInputs = document.querySelectorAll('input[name="decode_method"]');
    const decodeOrderDiv = document.querySelector('.decode-order');
    
    function toggleDecodeOrder() {
        const selectedMethod = document.querySelector('input[name="decode_method"]:checked').value;
        decodeOrderDiv.style.display = selectedMethod === 'all' ? 'block' : 'none';
    }
    
    decodeMethodInputs.forEach(input => {
        input.addEventListener('change', toggleDecodeOrder);
    });
    
    // æ‹–æ”¾ä¸Šä¼ é€»è¾‘
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        dropArea.classList.add('highlight');
    }
    
    function unhighlight(e) {
        dropArea.classList.remove('highlight');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            updateFileName(files[0].name);
        }
    }
    
    function validateFileType(file) {
        const method = document.querySelector('input[name="decode_method"]:checked').value;
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (method === 'vm_decrypt' && ext !== 'alp') {
            alert('VMè§£å¯†æ–¹å¼åªæ”¯æŒ .alp æ–‡ä»¶');
            return false;
        } else if (method === 'all' && ext !== 'lua') {
            alert('é€šç”¨è§£å¯†æ–¹å¼åªæ”¯æŒ .lua æ–‡ä»¶');
            return false;
        }
        return true;
    }
    
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            if (validateFileType(this.files[0])) {
                updateFileName(this.files[0].name);
            } else {
                this.value = '';  // æ¸…é™¤é€‰æ‹©çš„æ–‡ä»¶
                const dropMessage = dropArea.querySelector('.drop-message');
                dropMessage.innerHTML = `
                    <span class="icon">ğŸ“</span>
                    <p>æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <p class="sub-text">æ”¯æŒ .lua å’Œ .alp æ–‡ä»¶</p>
                `;
            }
        }
    });
    
    dropArea.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            if (validateFileType(files[0])) {
                fileInput.files = files;
                updateFileName(files[0].name);
            }
        }
    });
    
    // æ·»åŠ è§£å¯†æ–¹å¼åˆ‡æ¢æ—¶çš„æ–‡ä»¶æ¸…é™¤
    decodeMethodInputs.forEach(input => {
        input.addEventListener('change', function() {
            fileInput.value = '';  // æ¸…é™¤å·²é€‰æ‹©çš„æ–‡ä»¶
            const dropMessage = dropArea.querySelector('.drop-message');
            dropMessage.innerHTML = `
                <span class="icon">ğŸ“</span>
                <p>æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p class="sub-text">æ”¯æŒ .lua å’Œ .alp æ–‡ä»¶</p>
            `;
            toggleDecodeOrder();
        });
    });
    
    // æ¸…é™¤æ–‡ä»¶åŠŸèƒ½
    const clearBtn = document.getElementById('clearBtn');
    clearBtn.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
            fetch('/clear-files', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('æ¸…é™¤æ–‡ä»¶å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('æ¸…é™¤æ–‡ä»¶å¤±è´¥');
            });
        }
    });
    
    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
    toggleDecodeOrder();
});
</script>
{% endblock %} 